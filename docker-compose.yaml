version: "3.9"

networks:
  kafka-net:
    driver: bridge
  aft-external-net:
    external: true

services:
  broker:
    image: apache/kafka:latest
    hostname: broker
    container_name: broker
    ports:
      - 9092:9092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://broker:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_NODE_ID: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@broker:29093
      KAFKA_LISTENERS: PLAINTEXT://broker:29092,CONTROLLER://broker:29093,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LOG_DIRS: /tmp/kraft-combined-logs
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
    networks:
      - kafka-net

  kafka-writer:
    build:
      context: ./adapter/writer
      dockerfile: Dockerfile
    container_name: kafka-writer
    restart: unless-stopped
    ports:
      - 9000:5000
    environment:
      KAFKA_BOOTSTRAP: broker:29092
    depends_on:
      - broker
    networks:
      - kafka-net
      - aft-external-net

  kafka-reader:
    build:
      context: ./adapter/reader
      dockerfile: Dockerfile
    container_name: kafka-reader
    restart: unless-stopped
    environment:
      KAFKA_BOOTSTRAP: broker:29092
      TOPIC: test-topic
      API_URL: http://test:5000/print
      PERIOD: 1
      GROUP_ID: reader-group
      WINDOW_SIZE: 10
    depends_on:
      - broker
    networks:
      - kafka-net
      - aft-external-net

  test:
    build:
      context: ./test
      dockerfile: Dockerfile
    container_name: test
    restart: unless-stopped
    networks:
      - kafka-net

  swagger-ui:
    image: swaggerapi/swagger-ui:v5.17.14
    restart: always
    environment:
      URLS: |
        [
          { "name": "Kafka Reader API", "url": "/openapi/openapi-kafka-reader.yaml" },
          { "name": "Kafka Writer API", "url": "/openapi/openapi-kafka-writer.yaml" },
          { "name": "Kafka Print Service", "url": "/openapi/openapi-kafka-test.yaml" }
        ]
      URLS_PRIMARY_NAME: "Kafka API"
    ports:
      - "9010:8080"
    volumes:
      - ./openapi:/usr/share/nginx/html/openapi
